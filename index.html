<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup Concierge ‚Äî Master Hub</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <link rel="stylesheet" href="hub_core.css">
    <style>
        .pdf-tool-stage {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin-top: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
        }

        .pdf-tool-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 16px;
        }

        .pdf-dropzone {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.01);
        }

        .pdf-dropzone:hover {
            border-color: var(--primary);
            background: rgba(16, 185, 129, 0.05);
            transform: translateY(-2px);
        }

        .pdf-dropzone.active {
            border-color: var(--primary);
            animation: pulse-border 2s infinite;
        }

        @keyframes pulse-border {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }

        .pdf-editor-grid {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 24px;
        }

        .pdf-controls {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .pdf-preview-box {
            background: #0f172a;
            border-radius: 12px;
            min-height: 500px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .diag-badge {
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .diag-badge:hover {
            transform: scale(1.02);
            border-color: var(--primary);
            background: rgba(16, 185, 129, 0.1);
        }

        .diag-badge.active {
            border-color: var(--primary);
            background: rgba(16, 185, 129, 0.15);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.2);
        }

        .sc-gold-btn {
            background: #FFB81C !important;
            color: #000 !important;
            font-weight: 800 !important;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border: none !important;
        }

        .sc-gold-btn:hover {
            background: #e5a619 !important;
            box-shadow: 0 0 15px rgba(255, 184, 28, 0.4);
        }

        .coord-input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            background: rgba(0, 0, 0, 0.2);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        /* Tables - Mobile Health */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.85rem;
        }

        th,
        td {
            text-align: left;
            padding: 12px 8px;
            border-bottom: 1px solid var(--border);
        }

        th {
            color: var(--primary);
            font-weight: 700;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .finance-table-wrap {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin: 0 -10px;
            padding: 0 10px;
        }

        /* High-Fidelity Finance & markdown Extensions */
        .table-wrap {
            overflow-x: auto;
            margin: 20px 0;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.01);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        th {
            background: linear-gradient(135deg, var(--primary-dim), rgba(16, 185, 129, 0.15));
            color: var(--primary);
            text-align: left;
            padding: 12px 16px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 2px solid var(--primary);
        }

        td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover td {
            background: rgba(16, 185, 129, 0.05);
            color: var(--text-bright);
        }

        /* Alerts */
        .alert {
            padding: 16px 20px;
            border-radius: 12px;
            margin: 24px 0;
            border-left: 4px solid var(--border);
            background: rgba(255, 255, 255, 0.02);
            font-size: 0.9rem;
        }

        .alert-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 800;
            margin-bottom: 8px;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }

        .alert-tip {
            border-color: var(--gold);
            background: rgba(212, 175, 55, 0.05);
        }

        .alert-tip .alert-title {
            color: var(--gold);
        }

        .alert-important {
            border-color: var(--cyan);
            background: rgba(6, 182, 212, 0.05);
        }

        .alert-important .alert-title {
            color: var(--cyan);
        }

        .alert-warning {
            border-color: var(--red);
            background: rgba(239, 68, 68, 0.05);
        }

        .alert-warning .alert-title {
            color: var(--red);
        }

        /* Blockquotes */
        blockquote {
            border-left: 4px solid var(--primary-dim);
            background: rgba(255, 255, 255, 0.01);
            padding: 16px 24px;
            margin: 20px 0;
            font-style: italic;
            color: var(--text-dim);
            border-radius: 4px 12px 12px 4px;
        }

        @media (max-width: 600px) {
            .registry-grid {
                grid-template-columns: 1fr;
            }

            .stat-row {
                font-size: 0.75rem;
            }

            table {
                font-size: 0.7rem;
            }

            th,
            td {
                padding: 8px 4px;
            }
        }

        /* Document Viewer Styling */
        .viewer-overlay {
            position: fixed;
            inset: 0;
            background: rgba(10, 10, 15, 0.95);
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
            z-index: 3000;
            display: none;
            flex-direction: column;
            padding: 40px;
        }

        .viewer-overlay.open {
            display: flex;
        }

        .viewer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 20px;
        }

        .viewer-title {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
        }

        .viewer-content {
            flex: 1;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 32px;
            font-size: 1rem;
            line-height: 1.6;
            color: var(--text);
        }

        .viewer-close {
            background: var(--red-dim);
            color: var(--red);
            border: 1px solid var(--red);
            padding: 8px 20px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .viewer-close:hover {
            background: var(--red);
            color: #fff;
        }
    </style>
</head>

<body data-theme="business">
    <!-- Status Bar -->
    <div class="status-bar">
        <div class="status-items">
            <div class="branding-logo">CD</div>
            <span id="hub-title">Clinical Development
                Agency</span>
            <div class="business-only governance-badge">
                <span class="governance-dot"></span>
                Governed by **sprint_command**
            </div>
        </div>

        <div class="status-item business-only" id="global-revenue">
            <span class="status-label">Revenue Goal ($5K):</span>
            <div class="revenue-mini-bar">
                <div class="revenue-mini-fill" id="revenue-fill"></div>
            </div>
            <span class="status-value" id="revenue-current">...</span>
            <div class="status-link-row">
                <a href="playbook/clinical_architecture.md" class="status-link">üìã strategy</a>
                <a href="business/docs/wnq_wix_completion_guide_2026_02_12.md" class="status-link">üó∫Ô∏è Roadmap</a>
            </div>
        </div>

        <div class="status-item business-only">
            <span class="status-label">wnq Health:</span>
            <span class="status-value" style="color:var(--green)">100% OPERATIONAL</span>
        </div>

        <div class="status-item">
            <button onclick="app.toggleSettings()" class="settings-btn" onmouseover="this.style.color='var(--primary)'"
                onmouseout="this.style.color='var(--text-dim)'">‚öôÔ∏è</button>
        </div>
    </div>

    <div class="hud-nav">
        <button class="nav-btn active" id="btn-business" onclick="app.switchMode('business')">üè¢ Business Hub</button>
        <button class="nav-btn" id="btn-career" onclick="app.switchMode('career')">üöÄ career_hub</button>
        <button class="nav-btn" id="btn-registry" onclick="app.switchMode('registry')">üóÑÔ∏è Registry Hub</button>
        <button class="nav-btn" id="btn-finance" onclick="app.switchMode('finance')">üí∞ Finance Hub</button>
    </div>

    <div class="main">
        <!-- Left Sidebar: Progress & Pulse -->
        <div class="left-col">
            <div class="card">
                <div class="card-title"><span class="dot dot-primary"></span>Mode Readiness</div>
                <div id="readiness-ring"></div>
                <div id="stats-panel"></div>
            </div>

            <!-- Finance Tracker -->
            <div class="finance-widget">
                <div class="finance-header">
                    <div class="finance-title">üí∞ Financial Engine</div>
                </div>

                <div class="growth-container">
                    <div class="growth-label">
                        <span>Ecosystem Growth</span>
                        <span id="growthPercent" style="color: var(--accent);">0%</span>
                    </div>
                    <div class="growth-bar-bg">
                        <div class="growth-bar-fill" id="growthBar" style="width: 0%"></div>
                    </div>
                </div>

                <div class="finance-grid">
                    <div class="finance-stat">
                        <div class="stat-label">Proj. Gross (Monthly)</div>
                        <div class="stat-value" id="projGross">$10,400</div>
                    </div>
                    <div class="finance-stat">
                        <div class="stat-label">Clinical Rate</div>
                        <div class="stat-value">$60/hr</div>
                    </div>
                </div>

                <div class="time-shield">
                    <div class="shield-pulse"></div>
                    <div id="timeShieldStatus">Shield Active: 20:00 - 22:00</div>
                </div>
            </div>

            <div id="sidebar-contextual">
                <!-- Pipeline stages for Career, Service blocks for Business -->
            </div>
        </div>

        <!-- Center: Task Engine -->
        <div class="center-col">
            <!-- Critical Risk Card -->
            <div id="risk-card-container" style="display: none;">
                <div class="risk-card">
                    <div class="risk-icon">‚ö†Ô∏è</div>
                    <div class="risk-content">
                        <div class="risk-title">System Blocker Detected</div>
                        <div class="risk-msg" id="risk-message">Deployment Lag: Local dashboard has updates not yet
                            pushed to live URL.</div>
                    </div>
                </div>
            </div>

            <div class="card spotlight-card">
                <div class="card-title"><span class="dot dot-primary"></span>Next Actions
                    Spotlight</div>
                <div id="action-list"></div>
                <div id="extra-links" class="extra-links" style="display:none;">
                    <a id="tech-prep-link" href="career/siemens_prep.html" target="_blank" class="tech-prep-link">üìò
                        Siemens
                        / PPCL Study Guide ‚Üí</a>
                </div>
            </div>

            <div id="advisory-container" style="display: none;">
                <!-- silas_vance Card Rendered Here -->
            </div>

            <div id="task-sections-container">
                <!-- Rendered sections -->
            </div>
        </div>

        <!-- Right: Logs & Knowledge -->
        <div class="right-col">
            <div class="card">
                <div class="card-title log-card-title">
                    <span><span class="dot dot-purple"></span>Captain's Log</span>
                    <label class="handoff-filter" title="Show only handoffs/JB">
                        <input type="checkbox" id="filter-handoff" onclick="app.render()"> Handoffs
                    </label>
                </div>
                <div class="log-entries" id="log-list"></div>
                <div class="log-input-row">
                    <input type="text" id="log-input" class="input-field" placeholder="New entry..."
                        style="margin-bottom:0;" onkeydown="if(event.key==='Enter') app.addLog(this.value)">
                    <button onclick="app.addLog(document.getElementById('log-input').value)"
                        class="log-add-btn">+</button>
                </div>
            </div>

            <div class="lock-hub-row">
                <button onclick="app.lockHub()" class="lock-hub-btn">
                    üîí Lock Hub
                </button>
            </div>
        </div>

        <div id="sync-status" onclick="app.showSyncDetail()" title="Click for details">
            <span id="sync-dot" class="sync-dot"></span>
            <span id="sync-text">Local Only</span>
            <div class="sync-version">
                V8.8.8 Engine ‚Ä¢ Last Session: Feb 22
            </div>
        </div>
    </div>

    <!-- Document Viewer Overlay -->
    <div class="viewer-overlay" id="doc-viewer">
        <div class="viewer-header">
            <span class="viewer-title" id="viewer-title">Document Reader</span>
            <button class="viewer-close" onclick="app.closeReader()">Close</button>
        </div>
        <div class="viewer-content" id="viewer-content">
            <!-- Content -->
        </div>
    </div>

    <!-- Quiz Overlay -->
    <div class="overlay" id="quiz-overlay">
        <div class="quiz-modal fade-in" id="quiz-content">
            <!-- Dynamic Quiz Content -->
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="overlay" id="settings-overlay">
        <div class="settings-modal fade-in">
            <h2>‚öôÔ∏è Hub Settings</h2>
            <label class="status-label" for="gist-id">GitHub Gist ID</label>
            <input type="text" id="gist-id" class="input-field" placeholder="Gist ID" title="Enter Gist ID">
            <div id="pat-config-area">
                <label class="status-label" for="gist-pat">GitHub PAT</label>
                <input type="password" id="gist-pat" class="input-field" placeholder="Personal Access Token"
                    title="Enter GitHub PAT">
            </div>
            <div class="settings-maintenance">
                <label class="status-label">üõ†Ô∏è Maintenance</label>
                <button onclick="app.clearLogs()" title="Archive and condense current session logs"
                    class="btn-destructive">Archive
                    & Condense Session (Current Hub)</button>
            </div>
            <div class="settings-footer">
                <button onclick="app.toggleSettings()" class="btn-cancel">Cancel</button>
                <button onclick="app.saveSettings()" class="btn-save">Save
                    & Sync</button>
            </div>
        </div>
    </div>

    <script>
        const TASK_DATA = {
            // BUSINESS LANE
            phase1a: {
                lane: 'business', area: "sc", title: "‚ö° Phase 1A ‚Äî Monetization Sprint", icon: "‚ö°", badge: "Launch Feb 27", badgeColor: "var(--gold)", tasks: [
                    { id: "p1a1", text: "Scope wnq website as paid deliverable ($3,000 flat fee)", preChecked: true },
                    { id: "p1a0", text: "Send proposal + collect 50% upfront ($1,500) ‚Äî URGENT: Feb 15", preChecked: true },
                    { id: "p1a2", text: "Build wnq site using existing pipeline" },
                    { id: "p1a6", text: "Capture proof: before/after screenshots, metrics" },
                    { id: "p1a7", text: "Soft pre-sell to board (Feb 25)" },
                    { id: "p1a3", text: "üéØ Launch wnq website (Feb 27) + collect 50% ($1,500)" },
                    { id: "p1a4", text: "Create wnq Case Study IMMEDIATELY on launch day" }
                ]
            },
            wnq_phase1: {
                lane: 'business', area: "wnq", title: "wnq ‚Äî Phase 1: Foundation Polish", icon: "üé®", badge: "In Progress", badgeColor: "var(--orange)", tasks: [
                    { id: "w1", text: "Add social media icons (TikTok, IG) to header/footer", preChecked: true },
                    { id: "w2", text: "Integrate 'Struggle Lion' narrative behind Hero/legacy", preChecked: true },
                    { id: "w3", text: "Align Brand Pillars: Integrity, Strength, Faith", preChecked: true },
                    { id: "w6", text: "Leadership 'Cut Outs' (About Section)", preChecked: true },
                    { id: "w7", text: "Impact Pillars: Sports, Food, Events", preChecked: true },
                    { id: "w5", text: "SEO optimization ‚Äî title tags, meta descriptions" },
                    { id: "w32", text: "Apply gold accent (#FFB81C) across all Wix pages", preChecked: true }
                ]
            },
            wnq_phase2: {
                lane: 'business', area: "wnq", title: "wnq ‚Äî Phase 2: Tribute & Scholarship", icon: "üéì", badge: "Week of Feb 17", badgeColor: "var(--red)", tasks: [
                    { id: "w9", text: "Build Coach Ike Riley Sr. Tribute page (museum feel)" },
                    { id: "w12", text: "Build Ike Riley Sr Memorial Scholarship page" },
                    { id: "w25_ref", text: "Scaffold Coach Tribute Memorial (Museum Style)" }
                ]
            },
            bn_collab: {
                lane: 'business', area: "bn", title: "black_nexus ‚Äî Collaboration Hub", icon: "ü§ù", badge: "Live", badgeColor: "var(--green)", tasks: [
                    { id: "b23", text: "GitHub collaboration guide created", preChecked: true },
                    { id: "b24", text: "GitHub org created: blacknexuscda", preChecked: true },
                    { id: "b25", text: "JB Scott invited ‚Äî pending acceptance", preChecked: true },
                    { id: "b26", text: "Create first repo (brand-kit) and push files" },
                    { id: "b27", text: "Enable branch protection on main" }
                ]
            },

            // CAREER LANE
            prep_siemens: {
                lane: 'career', area: "technical", title: "üìò Siemens & PPCL Mastery", icon: "üìò", badge: "Priority", badgeColor: "var(--cyan)", tasks: [
                    { id: "ppcl1", text: "Review Siemens Insight Console Operator Guide" },
                    { id: "ppcl2", text: "Practice Conditional IF/THEN/ELSE Logic Blocks" },
                    { id: "ppcl3", text: "Audit Desigo CC Graphics & Point Mapping Protocols" },
                    { id: "ppcl4", text: "Technical Deep-Dive: BACnet/IP vs MS/TP Priority Arrays" }
                ]
            },
            prep_sterling: {
                lane: 'career', area: "interview", title: "üéØ AbbVie / Sterling Follow-Up", icon: "üéØ", badge: "Post-Interview", badgeColor: "var(--cyan)", tasks: [
                    { id: "c1", text: "Sterling/Xenqu onboarding Paperwork", preChecked: true },
                    { id: "c2", text: "Submit I-9 Documentation", preChecked: true },
                    { id: "f1_ref", text: "Review & personalize thank-you email draft" },
                    { id: "f3_ref", text: "Fill out Sterling Reference Request Form (.doc)" }
                ]
            },
            career_intel: {
                lane: 'career', area: "research", title: "üîç Career Intel ‚Äî completed Feb 15 ‚úÖ", icon: "üîç", badge: "Archive", badgeColor: "var(--teal)", tasks: [
                    { id: "r_arc", text: "Dossiers for Gino, John, Michael archived to action_items_archive.md", preChecked: true }
                ]
            },
            surgical_scripting: {
                lane: 'career', area: "technical", title: "Surgical Scripting Lab", icon: "üî¨", badge: "V8 Engine", badgeColor: "var(--cyan)", tasks: [
                    { id: "sc1", text: "The V8 Console (Interactive Guide)", preChecked: false },
                    { id: "sc2", text: "CLI Mastery: Surgical Shell Commands", preChecked: false },
                    { id: "sc3", text: "Automation: Gist-to-Hub Sync Script", preChecked: false }
                ]
            },

            // SHARED / UTILITY
            session_archival: {
                lane: 'business', area: "docs", title: "Session Archival ‚Äî completed Feb 15 ‚úÖ", icon: "üìÇ", badge: "Archive", badgeColor: "var(--purple)", tasks: [
                    { id: "sa_arc", text: "Feb 14-15 logs and summaries archived.", preChecked: true }
                ]
            },
            key_documents: {
                lane: 'shared', area: "docs", title: "üìÇ Master Docs ‚Äî completed Feb 15 ‚úÖ", icon: "üìÇ", badge: "Archive", badgeColor: "var(--purple)", tasks: [
                    { id: "kd_arc", text: "playbook, Brand Kit, and Benefits Guide finalized.", preChecked: true }
                ]
            }
        };


        const QUIZ_DATA = {
            siemens_ppcl: {
                lane: 'career',
                title: 'Siemens PPCL Syntax Diagnostic',
                questions: [
                    {
                        q: "Which command is used to set a point to a specific value in PPCL?",
                        options: ["VAL", "SET", "MOVE", "WRITE"],
                        correct: 1
                    },
                    {
                        q: "How do you define a conditional block in PPCL?",
                        options: ["IF/THEN/ELSE", "WHEN/DO", "CASE/OF", "SWITCH/CASE"],
                        correct: 0
                    },
                    {
                        q: "What does the command 'GOTO 100' do?",
                        options: ["Sets value to 100", "Jumps to line 100", "Waits for 100ms", "Stops execution"],
                        correct: 1
                    }
                ]
            },
            coding_check: {
                lane: 'career',
                title: 'CDA Surgical Scripting Check',
                questions: [
                    {
                        q: "Which protocol ensures dashboard state is synced globally?",
                        options: ["Surgical Sync", "Git Push Only", "Local Storage Only", "Manual Copy"],
                        correct: 0
                    },
                    {
                        q: "What is the primary role of the Captain's Log?",
                        options: ["Social media Posts", "Clinical Event Streaming", "Billing Only", "Design Mockups"],
                        correct: 1
                    }
                ]
            }
        };

        const NEXT_ACTIONS = [
            // CAREER ACTIONS
            { id: "a39", text: "Verify 'Nomad Mode' sync on iPhone", urgency: "now", source: "V8.9.1", lane: "career" },

            // BUSINESS ACTIONS
            { id: "a43", text: "Complete root folder renames for Business Ideas and Career Hub (blocked by handles)", urgency: "now", source: "RayRay/Ops", lane: "business" },
            { id: "a45", text: "Surgical Link Audit for deferred ideas (Nexus Coherence)", urgency: "later", source: "RayRay", lane: "business" },
            { id: "a40", text: "Execute Cloudflare Tunnel Setup (Guide: playbook/08_cloudflare_tunnel.md)", urgency: "soon", source: "Nomad Prep", lane: "business" },
            { id: "a41", text: "Advanced Scaling: Research VPS/OAuth integration for V9.0", urgency: "later", source: "strategy", lane: "business" },
            { id: "a42", text: "Monitor Sidecar heartbeat stability (24h soak test)", urgency: "now", source: "Ops", lane: "business" }
        ];

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // FINANCE_CONFIG ‚Äî Burn Rate & Freedom Level Data
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // GA (Aiden) Advisory: Track every dollar flowing in and out.
        // Update these numbers monthly. The dashboard calculates the rest.
        const FINANCE_CONFIG = {
            // Income streams (monthly)
            income: [
                { id: 'sterling', label: 'Sterling Engineering (W-2)', amount: 10400, startMonth: 2, type: 'career' },
                { id: 'wnq', label: 'WNQ Photography', amount: 400, startMonth: 1, type: 'business' },
                // Add new streams here:
                // { id: 'nexus', label: 'Black Nexus Clients', amount: 0, startMonth: 2, type: 'business' },
            ],
            // Monthly fixed expenses (update these with real numbers)
            expenses: [
                { id: 'rent', label: 'Rent / Housing', amount: 0, category: 'essentials' },
                { id: 'utilities', label: 'Utilities', amount: 0, category: 'essentials' },
                { id: 'food', label: 'Food & Groceries', amount: 0, category: 'essentials' },
                { id: 'transport', label: 'Transport / Gas', amount: 0, category: 'essentials' },
                { id: 'insurance', label: 'Insurance', amount: 0, category: 'essentials' },
                { id: 'phone', label: 'Phone / Internet', amount: 0, category: 'essentials' },
                { id: 'subscriptions', label: 'Software & Subs', amount: 0, category: 'ops' },
                { id: 'domains', label: 'Domains & Hosting', amount: 0, category: 'ops' },
                { id: 'tax_reserve', label: 'Tax Reserve (25%)', amount: 100, category: 'ops' },
                { id: 'misc', label: 'Misc / Variable', amount: 0, category: 'flex' },
            ],
            // Current liquid reserve
            savings: 0,
            // Freedom Level = monthly SC revenue needed to be fully W-2 independent
            freedomLevel: 5000,
            // Revenue goal for the $5k progress bar
            revenueGoal: 5000
        };

        class MasterApp {
            constructor() {
                this.mode = 'business';
                this.state = {
                    business: { tasks: {}, logs: [], completedActions: {}, collapsed: {} },
                    career: { tasks: {}, logs: [], completedActions: {}, collapsed: {} },
                    registry: { tasks: {}, logs: [], completedActions: {}, collapsed: {} },
                    archivedDocs: [],
                    vaultedDocs: []
                };
                if (!this.state.archivedDocs) this.state.archivedDocs = [];
                if (!this.state.vaultedDocs) this.state.vaultedDocs = [];
                this.registryData = null;
                this.isInitialized = false;
                this.init();
            }

            resolveDocPath(rawPath, isPdf = false) {
                if (!rawPath || rawPath === '#') return '#';

                // Strip landing folder and clean filename
                let filename = rawPath.split('/').pop();

                // Strip .md if we are going for pdf
                if (isPdf && filename.toLowerCase().endsWith('.md')) {
                    filename = filename.slice(0, -3);
                } else if (isPdf && filename.toLowerCase().endsWith('.pdf')) {
                    filename = filename.slice(0, -4);
                }

                let pathLower = rawPath.toLowerCase();

                // 1. Career documents
                if (pathLower.includes('career/docs/')) {
                    return `career/docs/${filename}${isPdf ? '.pdf' : ''}`;
                }

                // 2. playbook / governance
                if (pathLower.includes('playbook/')) {
                    return `playbook/${filename}${isPdf ? '.pdf' : ''}`;
                }

                // 3. resources (pdf ONLY)
                if (pathLower.includes('resources/') && isPdf) {
                    return `business/docs/resources/${filename}.pdf`;
                }

                // 4. Default Business Docs (black_nexus, wnq, advisory_panel)
                return `business/docs/${filename}${isPdf ? '.pdf' : ''}`;
            }

            parseLinks(text) {
                if (!text) return '';
                // 1. Handle standard [label](url)
                let html = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (match, label, url) => {
                    const isFile = url.endsWith('.md') || url.endsWith('.pdf') || url.includes('/docs/');
                    if (isFile) {
                        return `<a href="#" onclick="event.stopPropagation(); window.app.openReader('${url}', '${label}'); return false;" class="task-link" style="color:var(--text-bright);text-decoration:underline;cursor:pointer;font-weight:600;">${label}</a>`;
                    }
                    return `<a href="${url}" onclick="event.stopPropagation();" class="task-link" style="color:var(--text-bright);text-decoration:underline;cursor:pointer;font-weight:600;">${label}</a>`;
                });

                // 2. Handle raw file paths (e.g. finances/sc_finances_investment_tracker.md)
                // Matches items ending in .md or .pdf that are not already inside a link
                const pathRegex = /(^|\s)([a-zA-Z0-9_\-\/]+\.(?:md|pdf))(?=[\s\.,!\?;:)]|$)/g;
                html = html.replace(pathRegex, (match, space, path) => {
                    // Check if already processed by the [label](path) regex
                    if (html.indexOf(`>'${path}'<`) !== -1 || html.indexOf(`="${path}"`) !== -1) return match;

                    return `${space}<a href="#" onclick="event.stopPropagation(); window.app.openReader('${path}', '${path}'); return false;" class="task-link" style="color:var(--text-bright);text-decoration:underline;cursor:pointer;font-weight:600;">${path}</a>`;
                });

                return html;
            }

            setupIntercept() {
                document.addEventListener('click', (e) => {
                    const link = e.target.closest('a');
                    if (!link) return;

                    let href = link.getAttribute('href');
                    if (href && href.endsWith('.md') && !href.startsWith('http')) {
                        e.preventDefault();

                        // Handle potential hardcoded local paths by resolving them
                        if (href.includes('/') || href.includes('\\')) {
                            href = this.resolveDocPath(href, false);
                        }

                        const title = link.innerText || "Document";
                        this.openReader(href, title);
                    }
                });
            }

            async init() {
                await this.attemptHandshake();
                if (!this.checkAuthentication()) return;
                this.loadLocal();

                // Fetch dynamic registry data
                await this.loadRegistryData();
                this.updateFinance();

                const fullHash = window.location.hash.substring(1);
                const [targetMode] = fullHash.includes(':') ? fullHash.split(':') : [fullHash, null];

                if (targetMode === 'career' || targetMode === 'business' || targetMode === 'registry' || targetMode === 'finance') {
                    this.switchMode(targetMode);
                } else {
                    this.switchMode('business');
                }

                await this.syncFromSidecar(); // Cycle V8.8.9-Sec Airgap
                this.checkRisks();
                this.startHeartbeat();
                this.isInitialized = true;
                this.render();
                if (fullHash.includes(':')) this.handleDeepLink();
            }

            async attemptHandshake() {
                try {
                    const res = await this.fetchWithTimeout('http://127.0.0.1:3001/config', { timeout: 2000 });
                    if (res.ok) {
                        const config = await res.json();
                        this.sidecarConfig = config;
                        this.sidecarActive = true;
                        // Auto-adopt Gist ID if sidecar is providing it
                        if (config.gistId) {
                            const current = this.getGistConfig() || {};
                            if (current.gistId !== config.gistId) {
                                localStorage.setItem('sc_gist_config', JSON.stringify({ ...current, gistId: config.gistId }));
                            }
                        }
                        this.addLog("üîê Secure Handshake: Sidecar Connected.");
                    } else {
                        this.sidecarActive = false;
                    }
                } catch (e) {
                    this.sidecarActive = false;
                    console.warn("Handshake Failed: Sidecar unreachable.");
                }
            }

            startHeartbeat() {
                // Initial Telemetry Wave
                console.log("Telemetry Heartbeat Initialized [V8.8.8]");

                // Set sync heartbeat (5 minutes)
                this.heartbeatInterval = setInterval(() => {
                    this.syncFromGist();
                }, 5 * 60 * 1000);

                this.statusInterval = setInterval(() => {
                    this.renderSyncMeta();
                    this.updateSyncTimestamp(); // Mira: Freshness confirmation
                }, 30000);
            }

            updateSyncTimestamp() {
                this.renderSyncMeta();
            }

            async fetchWithTimeout(resource, options = {}) {
                // If sidecar is active and the resource is a local path (doesn't start with http/https), proxy it
                if (this.sidecarActive && !resource.startsWith('http')) {
                    resource = `http://127.0.0.1:3001/fetch?path=${encodeURIComponent(resource)}`;
                }
                const { timeout = 8000 } = options;
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), timeout);
                const response = await fetch(resource, {
                    ...options,
                    signal: controller.signal
                });
                clearTimeout(id);
                return response;
            }

            renderSyncMeta() {
                const meta = document.getElementById('sync-text');
                if (meta) {
                    const handshakeTag = this.sidecarActive ? " ‚Ä¢ üîê Handshake" : "";
                    if (this.syncStatus === 'synced') {
                        const now = new Date();
                        const last = this.lastSynced ? new Date(this.lastSynced) : now;
                        const diffSec = Math.floor((now - last) / 1000);
                        let staleness = "Just Now";
                        if (diffSec >= 60) {
                            staleness = `${Math.floor(diffSec / 60)}m ago`;
                        }

                        meta.innerText = `Auto-Sync: ${staleness}${handshakeTag} ‚Ä¢ Heartbeat Live`;
                        meta.title = `Last Sync: ${last.toLocaleTimeString()} (Cycle V8.9.2-Panel)`;
                        meta.style.color = "var(--text-dim)";
                    } else if (this.syncStatus === 'offline' || this.syncStatus === 'error') {
                        meta.innerText = `Auto-Sync: Local Only${handshakeTag} (Airgap Mode)`;
                        meta.style.color = "var(--red)";
                    } else if (this.syncStatus === 'syncing') {
                        meta.innerText = "Auto-Sync: Syncing...";
                        meta.style.color = "var(--orange)";
                    }
                }
            }

            checkRisks() {
                const container = document.getElementById('risk-card-container');
                const msg = document.getElementById('risk-message');
                if (!container || !msg) return;

                // Cycle V8.8.9-Sec: Gist PAT is no longer stored in localStorage.
                // We check if the Sidecar server is unreachable instead.
                fetch('http://127.0.0.1:3001/status')
                    .then(res => {
                        if (res.ok) container.style.display = 'none';
                    })
                    .catch(() => {
                        msg.innerText = "Security Alert: Surgical Sidecar offline. Run 'csync heartbeat' in terminal.";
                        container.style.display = 'block';
                    });
            }

            loadLocal() {
                const saved = localStorage.getItem('master_hub_state');
                if (saved) {
                    const loadedState = JSON.parse(saved);
                    // Merge loaded state with default structure to ensure new properties exist
                    this.state = {
                        ...this.state, // Default structure
                        ...loadedState, // Loaded data
                        business: { ...this.state.business, ...loadedState.business },
                        career: { ...this.state.career, ...loadedState.career },
                        registry: { ...this.state.registry, ...loadedState.registry },
                    };
                }
            }

            saveLocal() {
                localStorage.setItem('master_hub_state', JSON.stringify(this.state));
                this.debouncedSync();
            }

            switchMode(mode) {
                this.mode = mode;
                document.body.setAttribute('data-theme', mode === 'registry' ? 'business' : mode);
                document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById(`btn-${mode}`).classList.add('active');

                // Toggle lane-specific status elements
                document.querySelectorAll('.business-only').forEach(el => el.style.display = (mode === 'business' || mode === 'registry') ? 'flex' : 'none');

                // Initialize state if switching to a mode for the first time
                // Render Main Content Area
                const lanetasks = Object.values(TASK_DATA).filter(s => s.lane === this.mode || s.lane === 'shared');
                const currentModeState = this.state[this.mode] || { tasks: {}, logs: [], completedActions: {}, collapsed: {} };

                this.render();

                // Only update hash if it's a simple mode switch (no section deep link)
                const currentHash = window.location.hash.substring(1).split(':')[0];
                const validModes = ['career', 'business', 'registry', 'finance'];
                if (validModes.includes(mode) && currentHash !== mode) {
                    window.location.hash = mode;
                }

                this.render();
            }

            debouncedSync() {
                if (this.syncTimer) clearTimeout(this.syncTimer);
                this.syncTimer = setTimeout(() => this.syncToGist(), 3000);
            }

            async syncToGist() {
                this.setSyncStatus('syncing');
                try {
                    const filename = this.mode === 'business' ? 'sc_dashboard_state.json' : 'ch_dashboard_state.json';
                    const payload = {
                        files: {
                            [filename]: {
                                content: JSON.stringify(this.sanitizePayload(this.state[this.mode]), null, 2)
                            }
                        }
                    };

                    const res = await this.fetchWithTimeout('http://127.0.0.1:3001/push', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                        timeout: 5000
                    });

                    if (res.ok) {
                        const manifest = await res.json();
                        this.lastSynced = manifest.last_synced;
                        this.setSyncStatus('synced');
                    } else {
                        throw new Error(`Sidecar Error: ${res.status}`);
                    }
                } catch (e) {
                    console.error("Surgical Sync Push Error:", e);
                    this.setSyncStatus('offline');
                }
            }

            async syncFromSidecar() {
                this.setSyncStatus('syncing');
                try {
                    const lanes = ['business', 'career'];
                    for (const lane of lanes) {
                        const filename = lane === 'business' ? 'sc_dashboard_state.json' : 'ch_dashboard_state.json';
                        try {
                            const res = await this.fetchWithTimeout(`./data/${filename}`, { timeout: 3000 });
                            if (res.ok) {
                                this.state[lane] = await res.json();
                            }
                        } catch (e) { /* ignore individual local load failures */ }
                    }

                    const res = await this.fetchWithTimeout('http://127.0.0.1:3001/pull', { timeout: 5000 });
                    if (res.ok) {
                        const manifest = await res.json();
                        this.lastSynced = manifest.last_synced;
                        this.setSyncStatus('synced');
                    } else {
                        this.setSyncStatus('offline');
                    }
                    this.render();
                } catch (e) {
                    console.warn("Partition Active: Using local cache only.", e);
                    this.setSyncStatus('offline');
                    this.render();
                }
            }

            sanitizePayload(data) {
                const json = JSON.stringify(data);
                // Regex to catch GitHub PATs and block them from syncing
                const sanitized = json.replace(/ghp_[a-zA-Z0-9]{36}/g, "[REDACTED_SECRET]");
                if (json !== sanitized) {
                    console.warn("Security Layer: Secret detected and redacted from sync payload.");
                    this.addLog("‚ö†Ô∏è Security: Leak prevented during sync.");
                }
                return JSON.parse(sanitized);
            }

            getGistConfig() {
                // Secondary check for legacy secrets
                const saved = localStorage.getItem('sc_gist_config');
                if (saved) {
                    console.warn("Security Alert: Legacy secrets found in localStorage. Manual purging recommended.");
                }
                return saved ? JSON.parse(saved) : null;
            }

            async scaffoldDiagnostic() {
                this.addLog("Executing Surgical Protocol: Diagnostic Alpha...");
                try {
                    const shellPath = 'setup_concierge/resources/templates/diagnostic_alpha_surgical_shell.md';
                    this.addLog(`Scaffolding active. Template: ${shellPath}`);

                    // Simulate pre-fill by opening the reader with the shell path
                    // Justice can then copy-paste into a new log entry or document
                    this.openReader(shellPath, "Surgical Shell: Diagnostic Alpha");

                    this.addLog("Clinical Shell indexed for immediate use.");
                } catch (e) {
                    console.error("Scaffold Error:", e);
                    this.addLog("Scaffold Error: Check console for trace.");
                }
            }

            setSyncStatus(status, detail = '') {
                const dot = document.getElementById('sync-dot');
                const txt = document.getElementById('sync-text');

                this.syncStatus = status;
                this.lastSyncError = detail;

                if (!dot || !txt) return;

                dot.className = `sync-dot ${status}`;
                this.renderSyncMeta();
            }

            showSyncDetail() {
                if (this.lastSyncError) {
                    alert(`Sync Detail: ${this.lastSyncError}`);
                } else {
                    const cfg = this.getGistConfig();
                    if (!cfg || !cfg.pat) alert("Status: Configuration Needed. Open settings to set PAT/Gist ID.");
                    else alert("Status: Local Only. No errors recorded.");
                }
            }

            parsemarkdown(text) {
                if (!text) return '';

                // 1. Initial Escape
                let html = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

                // 2. High-Fidelity Extensions: Tables & Alerts
                const lines = html.split('\n');
                let processedLines = [];
                let inTable = false;

                for (let i = 0; i < lines.length; i++) {
                    let line = lines[i].trim();

                    // Alert Pattern Detection (> [!TYPE])
                    if (line.startsWith('&gt; [!')) {
                        const typeMatch = line.match(/&gt; \[!(.*?)\]/);
                        const type = typeMatch ? typeMatch[1].toLowerCase() : 'note';
                        const icon = type === 'tip' ? 'üí°' : type === 'important' ? 'üîç' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';

                        let alertContent = [];
                        while (i + 1 < lines.length && lines[i + 1].trim().startsWith('&gt;')) {
                            i++;
                            alertContent.push(lines[i].trim().replace(/^&gt;\s?/, ''));
                        }

                        processedLines.push(`<div class="alert alert-${type}">
                            <div class="alert-title"><span>${icon}</span> ${type}</div>
                            <div class="alert-body">${this.parsemarkdown(alertContent.join('\n'))}</div>
                        </div>`);
                        continue;
                    }

                    // Table Detection (| cell | cell |)
                    if (line.startsWith('|') && line.includes('|')) {
                        const cells = line.split('|').map(c => c.trim()).filter((c, idx, arr) => idx > 0 && idx < arr.length - 1);

                        if (!inTable) {
                            inTable = true;
                            // Peek next line for separator
                            if (i + 1 < lines.length && lines[i + 1].includes('---')) {
                                i++; // skip separator
                            }
                            processedLines.push('<div class="table-wrap"><table><thead><tr>' +
                                cells.map(h => `<th>${h}</th>`).join('') +
                                '</tr></thead><tbody>');
                        } else {
                            if (cells.length > 0) {
                                processedLines.push('<tr>' + cells.map(c => {
                                    let content = c.trim();
                                    if (content.includes('PROFITABLE')) content = `<span style="color:var(--primary);font-weight:800;">${content}</span>`;
                                    if (content.includes('RESERVED')) content = `<span style="color:var(--gold);font-weight:800;">${content}</span>`;
                                    return `<td>${content}</td>`;
                                }).join('') + '</tr>');
                            }
                        }
                        continue;
                    } else if (inTable) {
                        processedLines.push('</tbody></table></div>');
                        inTable = false;
                    }

                    // Standard Blockquotes (fallback)
                    if (line.startsWith('&gt;')) {
                        processedLines.push(`<blockquote>${line.replace(/^&gt;\s?/, '')}</blockquote>`);
                        continue;
                    }

                    processedLines.push(line);
                }
                if (inTable) processedLines.push('</tbody></table></div>');
                html = processedLines.join('\n');

                // 3. Structural/Inline Processing
                html = html.replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>');
                html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
                html = html.replace(/^# (.*)$/gm, '<h1>$1</h1>');
                html = html.replace(/^## (.*)$/gm, '<h2>$1</h2>');
                html = html.replace(/^### (.*)$/gm, '<h3>$1</h3>');
                html = html.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank">$1</a>');
                html = html.replace(/`(.*?)`/g, '<code>$1</code>');
                html = html.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
                html = html.replace(/- \[x\] (.+)/g, '<li><input type="checkbox" checked disabled> $1</li>');
                html = html.replace(/- \[ \] (.+)/g, '<li><input type="checkbox" disabled> $1</li>');
                html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
                html = html.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');
                html = html.replace(/((<li>.*<\/li>\n?)+)/g, '<ul>$1</ul>');
                html = html.replace(/^(?!<[a-z]|$)(.+)$/gm, '<p>$1</p>');
                html = html.replace(/<p>\s*<\/p>/g, '');

                return html;
            }

            async openReader(path, title = "Document") {
                const viewer = document.getElementById('doc-viewer');
                const content = document.getElementById('viewer-content');
                const titleEl = document.getElementById('viewer-title');

                if (!viewer || !content) return;

                titleEl.innerText = title;
                content.innerHTML = '<div style="text-align:center; padding:40px; opacity:0.5;">Loading clinical data...</div>';
                viewer.classList.add('open');
                document.body.style.overflow = 'hidden';

                try {
                    if (path.toLowerCase().endsWith('.pdf')) {
                        content.innerHTML = `<iframe src="${path}" width="100%" height="700px" style="border:none; border-radius:8px;"></iframe>`;
                    } else {
                        const res = await this.fetchWithTimeout(path);
                        const text = await res.text();
                        content.innerHTML = this.parsemarkdown(text);
                    }
                    viewer.scrollTop = 0;
                } catch (e) {
                    content.innerHTML = `<div style="color:var(--red); padding:20px; text-align:center;">
                        <h3>Surgical Error</h3>
                        <p>Failed to load document: ${path}</p>
                        <p style="font-size:0.7rem; opacity:0.7;">Error: ${e.message}</p>
                    </div>`;
                }
            }

            closeReader() {
                const viewer = document.getElementById('doc-viewer');
                if (viewer) viewer.classList.remove('open');
                document.body.style.overflow = 'auto';
            }

            async loadRegistryData() {
                this.setSyncStatus('syncing', "Syncing...");
                try {
                    const res = await this.fetchWithTimeout('registry_data.json', { timeout: 4000 });
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    this.registryData = await res.json();
                    this.addLog("Registry Sync: Data streams connected.");
                    this.setSyncStatus('synced', "Synced");
                } catch (e) {
                    console.error("Registry load failure:", e);
                    this.addLog(`Registry Sync: Failed to load dynamic data. Error: ${e.message}`);
                    this.setSyncStatus('error', "Local Only");
                    this.registryData = {};
                }

                // Load Finance Data as well (Surgical Integration)
                try {
                    const finRes = await this.fetchWithTimeout('finances/sc_finances_investment_tracker.md', { timeout: 3000 });
                    if (finRes.ok) {
                        this.financeTrackerRaw = await finRes.text();
                    }
                } catch (e) { /* silent fail for finance tracker */ }
            }

            calculateBurnRate() {
                const now = new Date();
                const currentMonth = now.getMonth(); // 0-indexed

                // Calculate active income for current month
                let totalIncome = 0;
                let businessIncome = 0;
                let careerIncome = 0;
                FINANCE_CONFIG.income.forEach(stream => {
                    if (currentMonth >= stream.startMonth) {
                        totalIncome += stream.amount;
                        if (stream.type === 'business') businessIncome += stream.amount;
                        else careerIncome += stream.amount;
                    }
                });

                // Calculate total expenses
                let totalExpenses = 0;
                const categories = {};
                FINANCE_CONFIG.expenses.forEach(exp => {
                    totalExpenses += exp.amount;
                    if (!categories[exp.category]) categories[exp.category] = { total: 0, items: [] };
                    categories[exp.category].total += exp.amount;
                    categories[exp.category].items.push(exp);
                });

                // Net and runway
                const netPosition = totalIncome - totalExpenses;
                const runway = totalExpenses > 0 && FINANCE_CONFIG.savings > 0
                    ? Math.round(FINANCE_CONFIG.savings / totalExpenses)
                    : totalExpenses === 0 ? Infinity : 0;

                // Freedom Level gap
                const freedomGap = Math.max(0, FINANCE_CONFIG.freedomLevel - businessIncome);
                const freedomPct = Math.min(100, Math.round((businessIncome / FINANCE_CONFIG.freedomLevel) * 100));

                return {
                    totalIncome, businessIncome, careerIncome,
                    totalExpenses, netPosition, runway,
                    freedomGap, freedomPct, categories
                };
            }

            renderFinance() {
                const container = document.getElementById('task-sections-container');
                const content = this.financeTrackerRaw ? this.parsemarkdown(this.financeTrackerRaw) : `
                    <div class="card">
                        <div class="card-title">Finance Hub Offline</div>
                        <p style="color:var(--text-dim)">Investment tracker not found at <code>finances/sc_finances_investment_tracker.md</code>.</p>
                    </div>
                `;

                // Calculate burn rate from FINANCE_CONFIG
                const burn = this.calculateBurnRate();
                const isDeficit = burn.netPosition < 0;
                const healthClass = isDeficit ? 'deficit' : '';
                const healthLabel = isDeficit ? 'DEFICIT' : burn.totalExpenses === 0 ? 'AWAITING DATA' : 'NET POSITIVE';

                // Gauge proportions
                const gaugeTotal = Math.max(burn.totalIncome, burn.totalExpenses, 1);
                const incomePct = Math.round((burn.totalIncome / gaugeTotal) * 100);
                const expensePct = Math.round((burn.totalExpenses / gaugeTotal) * 100);

                // Runway display
                const runwayDisplay = burn.runway === Infinity ? '‚àû' : burn.runway === 0 ? '‚Äî' : `${burn.runway}`;

                // Freedom gap badge
                const freedomClass = burn.freedomPct >= 100 ? 'achieved' : '';
                const freedomIcon = burn.freedomPct >= 100 ? '‚úÖ' : 'üéØ';
                const freedomText = burn.freedomPct >= 100
                    ? 'Freedom Level Achieved!'
                    : `$${burn.freedomGap.toLocaleString()}/mo to Freedom Level`;

                // Category breakdown rows
                const categoryColors = { essentials: 'var(--cyan)', ops: 'var(--purple)', flex: 'var(--gold)' };
                const categoryLabels = { essentials: 'üè† Essentials', ops: '‚öôÔ∏è Operations', flex: 'üé≤ Variable' };
                let breakdownHtml = '';
                if (burn.totalExpenses > 0) {
                    Object.entries(burn.categories).forEach(([cat, data]) => {
                        if (data.total > 0) {
                            const pct = Math.round((data.total / burn.totalExpenses) * 100);
                            const color = categoryColors[cat] || 'var(--text-dim)';
                            breakdownHtml += `
                                <div class="burn-category-row">
                                    <span class="burn-category-label">${categoryLabels[cat] || cat}</span>
                                    <div class="burn-category-bar">
                                        <div class="burn-category-fill" style="width:${pct}%; background:${color};"></div>
                                    </div>
                                    <span class="burn-category-amount">$${data.total.toLocaleString()}</span>
                                </div>`;
                        }
                    });
                } else {
                    breakdownHtml = '<div style="color:var(--text-dim); font-size:0.7rem; text-align:center; padding:12px;">Update FINANCE_CONFIG expenses to see breakdown</div>';
                }

                // Revenue goal (from config)
                const monthlyRev = burn.businessIncome;
                const goal = FINANCE_CONFIG.revenueGoal;
                const goalPct = Math.min(100, Math.round((monthlyRev / goal) * 100));

                container.innerHTML = `
                    <div class="hub-container fade-in">
                        <div class="card">
                            <div class="card-title"><span class="dot dot-primary"></span>Capital & ROI Ledger</div>
                            <div class="finance-table-wrap" style="margin-top:20px; font-size:0.9rem;">
                                ${content}
                            </div>
                        </div>

                        <div class="card burn-rate-card">
                            <div class="burn-rate-header">
                                <div class="card-title" style="margin:0;"><span class="dot" style="background:var(--cyan)"></span>Burn Rate Dashboard</div>
                                <div class="burn-rate-health ${healthClass}">
                                    <span class="health-dot"></span>
                                    ${healthLabel}
                                </div>
                            </div>

                            <div class="burn-gauge">
                                <div class="burn-gauge-income" style="width:${incomePct}%"></div>
                                <div class="burn-gauge-expense" style="width:${expensePct}%"></div>
                            </div>
                            <div class="burn-gauge-labels">
                                <span class="income-label">‚Üë Income: $${burn.totalIncome.toLocaleString()}/mo</span>
                                <span class="expense-label">‚Üì Expenses: $${burn.totalExpenses.toLocaleString()}/mo</span>
                            </div>

                            <div class="burn-metrics">
                                <div class="burn-metric">
                                    <div class="burn-metric-value" style="color:var(--red)">$${burn.totalExpenses.toLocaleString()}</div>
                                    <div class="burn-metric-label">Monthly Burn</div>
                                </div>
                                <div class="burn-metric">
                                    <div class="burn-metric-value" style="color:${isDeficit ? 'var(--red)' : 'var(--green)'}">
                                        ${isDeficit ? '-' : '+'}$${Math.abs(burn.netPosition).toLocaleString()}
                                    </div>
                                    <div class="burn-metric-label">Net Position</div>
                                </div>
                                <div class="burn-metric">
                                    <div class="burn-metric-value" style="color:var(--cyan)">${runwayDisplay}</div>
                                    <div class="burn-metric-label">Runway (months)</div>
                                </div>
                                <div class="burn-metric">
                                    <div class="burn-metric-value" style="color:var(--gold)">${burn.freedomPct}%</div>
                                    <div class="burn-metric-label">Freedom Level</div>
                                </div>
                            </div>

                            <div class="burn-breakdown">
                                <div class="burn-breakdown-title">Expense Breakdown</div>
                                ${breakdownHtml}
                            </div>

                            <div class="freedom-gap-badge ${freedomClass}">
                                ${freedomIcon} ${freedomText}
                            </div>
                        </div>

                        <div class="card" style="margin-top:24px; border-left: 4px solid var(--gold);">
                            <div class="status-label" style="color:var(--gold)">Scaling Target: $${goal.toLocaleString()}/mo</div>
                            <div class="revenue-progress" style="height:12px; margin: 12px 0;">
                                <div id="goal-progress-fill" style="width:${goalPct}%; background:var(--gold); box-shadow: 0 0 15px var(--gold-dim);"></div>
                            </div>
                            <div style="display:flex; justify-content:space-between; font-size:0.75rem; font-weight:700;">
                                <span style="color:var(--text-bright)">$${monthlyRev.toLocaleString()} Current (SC Revenue)</span>
                                <span style="opacity:0.6;">${goalPct}% of Freedom Level</span>
                            </div>
                        </div>
                            <div class="card-title"><span class="dot dot-primary"></span>Operational Actions</div>
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:20px;">
                                <div class="diag-badge" style="cursor:pointer;" onclick="app.openReader('finances/invoices_sent/', 'Invoices Sent')">üìÅ Invoices Sent</div>
                                <div class="diag-badge" style="cursor:pointer;" onclick="app.openReader('finances/expenses/', 'Expenses')">üìÅ Expense Records</div>
                                <div class="diag-badge" style="cursor:pointer;" onclick="app.openReader('finances/invoices_received/', 'Invoices Received')">üìÅ Invoices Received</div>
                                <div class="diag-badge" style="cursor:pointer;" onclick="window.open('https://github.com/thesetupconcierge/command-center/tree/main/finances', '_blank')">üåê GitHub Repo</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            updateFinance() {
                const now = new Date();
                const currentMonth = now.getMonth(); // 0-indexed (1 is Feb, 2 is March)

                // Baseline: Sterling $60/hr * 40hrs * 4.33 weeks = ~$10,400
                // Start date is March 2nd, 2026.
                let careerGross = 10400;
                let businessRevenue = 400; // Hardcoded baseline for Feb

                // If currently in February, career revenue is $0
                if (currentMonth === 1) {
                    careerGross = 0;
                }

                const totalEcosystem = careerGross + businessRevenue;
                const growthFactor = careerGross > 0 ? (businessRevenue / careerGross) * 100 : 100;

                const growthBar = document.getElementById('growthBar');
                const growthPct = document.getElementById('growthPercent');
                const projGross = document.getElementById('projGross');

                if (growthBar) growthBar.style.width = `${Math.min(growthFactor, 100)}%`;
                if (growthPct) growthPct.innerText = careerGross > 0 ? `${growthFactor.toFixed(1)}%` : "100% (SC Only)";
                if (projGross) projGross.innerText = `$${totalEcosystem.toLocaleString()}`;

                // Update Revenue Mini Bar in Header
                const revFill = document.getElementById('revenue-fill');
                const revCurrent = document.getElementById('revenue-current');
                const goal = 5000;
                const pct = Math.min(100, (businessRevenue / goal) * 100);

                if (revFill) revFill.style.width = `${pct}%`;
                if (revCurrent) revCurrent.innerText = `$${businessRevenue.toLocaleString()}`;

                // Calculate Shield Status
                const hour = now.getHours();
                const statusEl = document.getElementById('timeShieldStatus');

                if (statusEl) {
                    if (hour >= 20 && hour <= 22) {
                        statusEl.innerText = "Shield Active: Deep Work Mode";
                        statusEl.parentElement.style.background = "rgba(59, 130, 246, 0.15)";
                        statusEl.parentElement.style.borderColor = "#3b82f6";
                    } else {
                        statusEl.innerText = "Shield Standby: SC Core Hours";
                        statusEl.parentElement.style.background = "rgba(16, 185, 129, 0.1)";
                        statusEl.parentElement.style.borderColor = "rgba(16, 185, 129, 0.2)";
                        statusEl.previousElementSibling.style.background = "#10b981"; // pulse
                    }
                }
            }

            getTaskState(id) {
                if (this.state[this.mode] && this.state[this.mode].tasks && this.state[this.mode].tasks[id]) return this.state[this.mode].tasks[id];
                // Check preChecked
                for (const s of Object.values(TASK_DATA)) {
                    const t = s.tasks.find(x => x.id === id);
                    if (t && t.preChecked) return 'done';
                }
                return 'todo';
            }

            cycleTask(id) {
                const current = this.getTaskState(id);
                const next = current === 'todo' ? 'progress' : current === 'progress' ? 'done' : 'todo';
                this.state[this.mode].tasks[id] = next;
                this.saveLocal();
                this.render();
            }

            addLog(text) {
                if (!text.trim()) return;
                const now = new Date();
                const time = now.toLocaleDateString() + ' ' + now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                if (!this.state[this.mode].logs) this.state[this.mode].logs = [];
                this.state[this.mode].logs.unshift({ text: text.trim(), time });
                document.getElementById('log-input').value = '';
                this.saveLocal();
                this.render();
            }

            clearLogs() {
                if (confirm(`‚ö†Ô∏è Are you sure you want to Archive & Condense all logs for the ${this.mode} hub? This purges the dashboard feed; ensure your extraction is complete first.`)) {
                    this.state[this.mode].logs = [];
                    this.addLog(`üßπ ${this.mode.charAt(0).toUpperCase() + this.mode.slice(1)} Session Archived & Condensed.`);
                    this.saveLocal();
                    this.render();
                }
            }

            toggleAction(id) {
                this.state[this.mode].completedActions[id] = !this.state[this.mode].completedActions[id];
                this.saveLocal();
                this.render();
            }

            toggleSettings() {
                const overlay = document.getElementById('settings-overlay');
                if (!overlay) return;
                overlay.classList.toggle('open');

                if (overlay.classList.contains('open')) {
                    const cfg = this.getGistConfig() || {};
                    document.getElementById('gist-id').value = cfg.gistId || '';

                    const patArea = document.getElementById('pat-config-area');
                    if (this.sidecarActive) {
                        patArea.innerHTML = `
                            <div style="background:rgba(16, 185, 129, 0.1); border:1px solid var(--primary); padding:12px; border-radius:8px; display:flex; gap:12px; align-items:center; margin-top:8px;">
                                <span style="font-size:1.2rem;">üîê</span>
                                <div>
                                    <div style="font-weight:700; color:var(--primary); font-size:0.75rem;">Surgically Connected</div>
                                    <div style="font-size:0.65rem; opacity:0.7;">PAT is managed by local Sidecar daemon.</div>
                                </div>
                            </div>
                        `;
                    } else {
                        patArea.innerHTML = `
                            <label class="status-label" for="gist-pat">GitHub PAT</label>
                            <input type="password" id="gist-pat" class="input-field" placeholder="Personal Access Token" value="${cfg.pat || ''}">
                        `;
                    }
                }
            }

            saveSettings() {
                const id = document.getElementById('gist-id').value;
                const patField = document.getElementById('gist-pat');
                const pat = patField ? patField.value : '';

                const current = this.getGistConfig() || {};
                localStorage.setItem('sc_gist_config', JSON.stringify({
                    gistId: id || current.gistId,
                    pat: pat || current.pat
                }));
                this.toggleSettings();
                this.syncFromGist();
            }

            startQuiz(id) {
                this.currentQuiz = { id, step: 0, score: 0 };
                document.getElementById('quiz-overlay').classList.add('open');
                this.renderQuiz();
            }

            renderQuiz() {
                const qd = QUIZ_DATA[this.currentQuiz.id];
                const step = qd.questions[this.currentQuiz.step];
                const container = document.getElementById('quiz-content');

                if (this.currentQuiz.step < qd.questions.length) {
                    container.innerHTML = `
                        <h3 style="margin-bottom:12px;color:var(--gold)">${qd.title}</h3>
                        <div class="status-label" style="margin-bottom:20px">Question ${this.currentQuiz.step + 1} of ${qd.questions.length}</div>
                        <p style="margin-bottom:24px;font-weight:600">${step.q}</p>
                        ${step.options.map((opt, i) => `
                            <div class="quiz-option" onclick="app.submitAnswer(${i})">${opt}</div>
                        `).join('')}
                    `;
                } else {
                    const final = Math.round((this.currentQuiz.score / qd.questions.length) * 100);
                    container.innerHTML = `
                        <h3 style="margin-bottom:12px;color:var(--green)">Diagnostic Complete</h3>
                        <div style="font-size:3rem;font-weight:800;margin:20px 0">${final}%</div>
                        <p style="margin-bottom:24px;color:var(--text-dim)">Knowledge verification saved to session log.</p>
                        <button onclick="app.closeQuiz()" style="background:var(--primary);color:#000;border:none;padding:12px 24px;border-radius:8px;font-weight:700;cursor:pointer;width:100%">Close Diagnostic</button>
                    `;
                    this.addLog(`completed ${qd.title}: Score ${final}%`);
                }
            }

            submitAnswer(idx) {
                const qd = QUIZ_DATA[this.currentQuiz.id];
                if (idx === qd.questions[this.currentQuiz.step].correct) this.currentQuiz.score++;
                this.currentQuiz.step++;
                this.renderQuiz();
            }

            closeQuiz() {
                document.getElementById('quiz-overlay').classList.remove('open');
                this.currentQuiz = null;
            }

            copyDeepLink(sectionId) {
                const url = new URL(window.location);
                url.hash = `${this.mode}:${sectionId}`;
                navigator.clipboard.writeText(url.href);
                this.addLog(`Deep link copied: ${sectionId}`);
            }

            handleDeepLink() {
                const fullHash = window.location.hash.substring(1);
                if (!fullHash) return;

                // Allow mode:section, just mode, or just section (if mode is current)
                const [targetMode, sectionId] = fullHash.includes(':') ? fullHash.split(':') : [fullHash, null];

                if (['career', 'business', 'registry'].includes(targetMode)) {
                    if (this.mode !== targetMode) {
                        this.switchMode(targetMode);
                    }
                }

                if (sectionId) {
                    // Give the DOM a moment to re-render if we switched modes
                    setTimeout(() => {
                        const el = document.getElementById(sectionId);
                        if (el) {
                            el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            el.classList.add('section-highlight');
                            setTimeout(() => el.classList.remove('section-highlight'), 3000);
                        }
                    }, 300);
                }
            }

            lockHub() {
                localStorage.removeItem('sc_hub_authenticated');
                location.reload();
            }

            checkAuthentication() {
                const authenticated = localStorage.getItem('sc_hub_authenticated');
                const cfg = this.getGistConfig();
                const isLocal = window.location.protocol === 'file:';

                console.log("Auth Diagnostic:", { isLocal, sidecarActive: this.sidecarActive, authenticated });

                // Loopback/Local bypass
                if (isLocal || this.sidecarActive) {
                    console.log("Auth Passed: Secure Environment.");
                    return true;
                }

                // If no PAT/Gist configured, let them in to set it up
                if (!cfg || !cfg.pat) {
                    console.log("Auth Passed: No secrets found, jumping to settings.");
                    return true;
                }

                if (!authenticated) {
                    const pass = prompt('Enter Hub Passcode:');
                    if (pass && pass === cfg.pat.substring(0, 4)) {
                        localStorage.setItem('sc_hub_authenticated', 'true');
                        return true;
                    } else {
                        console.error("Auth Failed: Passcode mismatch or prompt canceled.");
                        document.body.innerHTML = `<div style="height:100vh; display:flex; align-items:center; justify-content:center; flex-direction:column; color:var(--text-dim); font-family:sans-serif; text-align:center; padding:20px;">
                            <h1 style="color:var(--red)">Access Denied</h1>
                            <p>Handshake failed and Passcode was incorrect.</p>
                            <p style="font-size:0.7rem; opacity:0.6; margin-top:10px;">Sidecar Status: ${this.sidecarActive ? 'üü¢ Connected' : 'üî¥ Offline'}</p>
                            <button onclick="location.reload()" style="margin-top:20px; background:var(--gold); color:#000; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:700;">Retry Handshake</button>
                        </div>`;
                        return false;
                    }
                }
                return true;
            }


            render() {
                if (!this.isInitialized) return;

                const ring = document.getElementById('readiness-ring');
                const stats = document.getElementById('stats-panel');
                const sideCtx = document.getElementById('sidebar-contextual');
                const actionsList = document.getElementById('action-list');
                const advContainer = document.getElementById('advisory-container');
                const revenuePanel = document.getElementById('global-revenue');

                // If core UI is missing (e.g. Access Denied screen active), abort silently.
                if (!ring || !stats) return;

                const lanetasks = Object.values(TASK_DATA).filter(s => s.lane === this.mode || s.lane === 'shared');
                const allLanetasks = lanetasks.flatMap(s => s.tasks);
                const done = allLanetasks.filter(t => this.getTaskState(t.id) === 'done').length;
                const pct = allLanetasks.length ? Math.round((done / allLanetasks.length) * 100) : 0;

                // Progress Ring
                const circ = 2 * Math.PI * 62;
                const offset = circ - (pct / 100) * circ;
                ring.innerHTML = `
                    <div class="big-ring-wrap">
                        <div class="big-ring">
                            <svg viewBox="0 0 140 140">
                                <circle class="bg" cx="70" cy="70" r="62"/>
                                <circle class="fill" cx="70" cy="70" r="62" stroke="var(--primary)" stroke-dasharray="${circ}" stroke-dashoffset="${offset}"/>
                            </svg>
                            <div class="big-ring-pct">
                                <div class="num">${pct}%</div>
                                <div class="label">${this.mode === 'business' ? 'Consulting Ready' : 'Interview Ready'}</div>
                            </div>
                        </div>
                    </div>`;

                // Stats Panel
                stats.innerHTML = `
                    <div class="stat-row"><span class="status-label">Total Workload</span><span class="status-value">${allLanetasks.length} units</span></div>
                    <div class="stat-row"><span class="status-label">Shipped</span><span class="status-value" style="color:var(--green)">${done}</span></div>
                `;

                // Sidebar Contextual (Noa: Contextual space reclaim)
                if (sideCtx) {
                    const hideDiagnostics = this.mode === 'finance' || this.mode === 'registry';
                    const diagList = Object.entries(QUIZ_DATA).filter(([id, q]) => q.lane === this.mode);

                    if (diagList.length && !hideDiagnostics) {
                        sideCtx.innerHTML = `
                            <div class="card fade-in" style="margin-top:16px;">
                                <div class="status-label">Diagnostic Tools</div>
                                <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px;">
                                    ${diagList.map(([id, q]) => `
                                        <div class="diag-badge" onclick="app.startQuiz('${id}')">
                                            ‚ö° ${q.title}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    } else {
                        sideCtx.innerHTML = '';
                    }
                }

                // Revenue Spotlight
                if (revenuePanel) {
                    const rev = 400;
                    const rCurrent = document.getElementById('revenue-current');
                    const rFill = document.getElementById('revenue-fill');
                    if (rCurrent) rCurrent.innerText = `$${rev.toLocaleString()}`;
                    if (rFill) rFill.style.width = `${(rev / 5000) * 100}%`;
                }

                // Action List Spotlight
                if (actionsList) {
                    const actions = NEXT_ACTIONS.filter(a => a.lane === this.mode);
                    actionsList.innerHTML = actions.map(a => {
                        const isDone = (this.state[this.mode].completedActions && this.state[this.mode].completedActions[a.id]) || a.preChecked;
                        return `
                            <div class="action-item ${isDone ? 'completed' : ''}" onclick="app.toggleAction('${a.id}')">
                                <div class="action-check"></div>
                                <div>
                                    <div class="task-text" style="font-size:0.8rem;">${this.parseLinks(a.text)}</div>
                                    <div class="status-label" style="font-size:0.6rem;">${a.source}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                // Extra Links Visibility (Career only)
                const extraLinks = document.getElementById('extra-links');
                if (extraLinks) extraLinks.style.display = this.mode === 'career' ? 'block' : 'none';

                // Advisory Card
                if (advContainer) {
                    if (this.mode === 'business') {
                        advContainer.style.display = 'block';
                        advContainer.innerHTML = `
                            <div class="card advisory-card fade-in">
                                <div class="advisory-header">
                                    <div class="advisory-avatar">ü¶â</div>
                                    <div class="advisory-info">
                                        <div class="advisory-name">silas_vance</div>
                                        <div class="advisory-title">Strategic Lead</div>
                                    </div>
                                    <div class="section-badge" style="background:var(--purple-dim); color:var(--purple)">DEEP INSIGHT</div>
                                </div>
                                <div class="advisory-quote">
                                    "Price the value, not the hours. The ecosystem survives on the Clinical Standard, or it doesn't survive at all."
                                </div>
                                <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                                    <button class="advisory-btn" onclick="app.openReader('business/docs/silas_vance_money_shot_report.md', 'silas_vance Money Shot')">View Money Shot ‚Üí</button>
                                    <button class="advisory-btn" style="background:var(--cyan-dim); border-color:var(--cyan); color:var(--cyan);" onclick="app.scaffoldDiagnostic()">Surgical Trigger</button>
                                </div>
                            </div>
                        `;
                    } else {
                        advContainer.style.display = 'none';
                    }
                }

                if (this.mode === 'registry') {
                    this.renderRegistry();
                } else if (this.mode === 'finance') {
                    this.renderFinance();
                } else if (this.mode === 'pdf') {
                    this.renderPdfUtility();
                } else {
                    const sectionsContainer = document.getElementById('task-sections-container');
                    if (sectionsContainer) {
                        sectionsContainer.innerHTML = `
                            <div id="${this.mode}-portal" class="hub-container fade-in">
                                ${lanetasks.map(s => {
                            const sDone = s.tasks.filter(t => this.getTaskState(t.id) === 'done').length;
                            const sectionKey = Object.keys(TASK_DATA).find(key => TASK_DATA[key] === s);
                            const isCollapsed = this.state[this.mode].collapsed ? this.state[this.mode].collapsed[s.title] !== false : true;
                            return `
                                        <div class="card ${isCollapsed ? 'collapsed' : ''}" id="${sectionKey}">
                                            <div class="task-section-header" onclick="app.toggleSection('${s.title}')">
                                                <div class="section-title">
                                                    <span class="section-chevron" style="transform: ${isCollapsed ? 'rotate(-90deg)' : 'rotate(0deg)'}; margin-right:8px;">‚ñº</span>
                                                    ${s.icon || ''} ${s.title} 
                                                    <span class="section-badge" style="background:${s.badgeColor}20;color:${s.badgeColor}">${s.badge}</span>
                                                </div>
                                                <div class="status-label">${sDone}/${s.tasks.length}</div>
                                                <span class="deeplink-btn" title="Copy Deep Link" onclick="event.stopPropagation(); app.copyDeepLink('${sectionKey}')">üîó</span>
                                            </div>
                                            <div class="section-body" style="display: ${isCollapsed ? 'none' : 'block'}">
                                                <div class="task-list">
                                                    ${s.tasks.map(t => `
                                                        <div class="task-item" data-status="${this.getTaskState(t.id)}">
                                                            <div class="task-check" data-state="${this.getTaskState(t.id)}" onclick="app.cycleTask('${t.id}')"></div>
                                                            <div class="task-text">${this.parseLinks(t.text)}</div>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </div>
                                        </div>
                                    `;
                        }).join('')}
                            </div>
                        `;
                    }
                }

                // Logs Rendering
                const logList = document.getElementById('log-list');
                const filterBtn = document.getElementById('filter-handoff');
                if (logList) {
                    const isFiltered = filterBtn ? filterBtn.checked : false;
                    let currentLogs = (this.state[this.mode] && this.state[this.mode].logs) ? this.state[this.mode].logs : (this.state['business'] ? this.state['business'].logs : []);

                    if (isFiltered) {
                        currentLogs = currentLogs.filter(l => l.text.toLowerCase().includes('#handoff') || l.text.toLowerCase().includes('#jb'));
                    }

                    logList.innerHTML = currentLogs.map(l => {
                        const isHandoff = l.text.toLowerCase().includes('#handoff') || l.text.toLowerCase().includes('#jb');
                        return `
                            <div class="log-entry" ${isHandoff ? 'data-category="handoff"' : ''}>
                                <div class="log-time">${l.time}</div>
                                <div class="log-text">${this.parseLinks(l.text)}</div>
                            </div>
                        `;
                    }).join('');
                }
            }

            setPdfTool(tool) {
                this.activePdfTool = tool;
                this.render();
                this.renderPdfStage();
            }

            renderPdfUtility() {
                const container = document.getElementById('task-sections-container');
                container.innerHTML = `
            <div class="hub-container fade-in" >
                        <div class="card" style="margin-bottom:20px;">
                            <div class="card-title"><span class="dot" style="background:var(--primary)"></span>pdf Surgical Laboratory</div>
                            <p style="font-size:0.8rem; color:var(--text-dim); margin-bottom:20px;">Surgical document modification. All processing happens locally in-browser [V8.8.9-Alpha].</p>
                            
                            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:16px;">
                                <div class="diag-badge ${this.activePdfTool === 'overlay' ? 'active' : ''}" style="padding:16px; height:auto; flex-direction:column; align-items:flex-start; gap:8px;" onclick="app.setPdfTool('overlay')">
                                    <span style="font-size:1.2rem;">‚úçÔ∏è</span>
                                    <div style="font-weight:700;">Text Overlay</div>
                                    <div style="font-size:0.65rem; opacity:0.7;">Add dates/names to docs</div>
                                </div>
                                <div class="diag-badge ${this.activePdfTool === 'merge' ? 'active' : ''}" style="padding:16px; height:auto; flex-direction:column; align-items:flex-start; gap:8px;" onclick="app.setPdfTool('merge')">
                                    <span style="font-size:1.2rem;">üîó</span>
                                    <div style="font-weight:700;">Merge pdfs</div>
                                    <div style="font-size:0.65rem; opacity:0.7;">Combine multiple files</div>
                                </div>
                                <div class="diag-badge ${this.activePdfTool === 'flatten' ? 'active' : ''}" style="padding:16px; height:auto; flex-direction:column; align-items:flex-start; gap:8px;" onclick="app.setPdfTool('flatten')">
                                    <span style="font-size:1.2rem;">üìë</span>
                                    <div style="font-weight:700;">Flatten Forms</div>
                                    <div style="font-size:0.65rem; opacity:0.7;">Seal fields for submittal</div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="pdf-tool-stage">
                            <div style="text-align:center; padding:60px; color:var(--text-dim); opacity:0.5; border: 2px dashed var(--border); border-radius:12px;">
                                Select a surgical tool to begin configuration.
                            </div>
                        </div>
                    </div>
            `;
                if (this.activePdfTool) this.renderPdfStage();
            }

            async renderPdfStage() {
                const stage = document.getElementById('pdf-tool-stage');
                if (!stage) return;

                if (this.activePdfTool === 'overlay') {
                    stage.innerHTML = `
            <div class="pdf-tool-stage fade-in" >
                            <div class="pdf-tool-header">
                                <h3 style="color:var(--text-bright)">Surgical Overlay Engine</h3>
                                <button class="advisory-btn sc-gold-btn" style="width:auto; padding:8px 20px;" onclick="app.executePdfOverlay()">Download Modified pdf</button>
                            </div>
                            <div class="pdf-editor-grid">
                                <div class="pdf-controls">
                                    <div class="pdf-dropzone" onclick="document.getElementById('pdf-file-input').click()">
                                        <div style="font-size:2rem; margin-bottom:8px;">üìÑ</div>
                                        <div style="font-size:0.8rem; font-weight:700;">Load Target Document</div>
                                        <div style="font-size:0.6rem; opacity:0.6;">Click to browse</div>
                                        <input type="file" id="pdf-file-input" style="display:none" onchange="app.handlePdfLoad(event)">
                                    </div>
                                    <div class="card" style="padding:16px; background:rgba(255,255,255,0.02)">
                                        <div class="status-label" style="margin-bottom:8px; color:var(--primary)">Overlay Text Content</div>
                                        <input type="text" id="pdf-text-value" class="input-field" placeholder="Justice McKinney" style="font-size:0.9rem; margin-bottom:16px;">
                                        
                                        <div class="status-label" style="margin-bottom:8px; color:var(--primary)">Placement Coordinates</div>
                                        <div class="coord-input-group">
                                            <div>
                                                <div class="status-label" style="font-size:0.6rem; opacity:0.5;">X-AXIS</div>
                                                <input type="number" id="pdf-text-x" class="input-field" value="50" style="padding:6px; border:none; background:transparent; font-size:0.9rem;">
                                            </div>
                                            <div>
                                                <div class="status-label" style="font-size:0.6rem; opacity:0.5;">Y-AXIS</div>
                                                <input type="number" id="pdf-text-y" class="input-field" value="50" style="padding:6px; border:none; background:transparent; font-size:0.9rem;">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="pdf-preview-box" id="pdf-preview-canvas">
                                    <div style="opacity:0.3; font-size:0.8rem;">Preview logic active after load</div>
                                </div>
                            </div>
                        </div>
            `;
                } else if (this.activePdfTool === 'merge') {
                    stage.innerHTML = `
            <div class="pdf-tool-stage fade-in" >
                            <div class="pdf-tool-header">
                                <h3 style="color:var(--text-bright)">Document Merger Lab</h3>
                                <button class="advisory-btn sc-gold-btn" style="width:auto; padding:8px 20px;" onclick="app.executePdfMerge()">Generate Merged pdf</button>
                            </div>
                            <div class="pdf-dropzone" onclick="document.getElementById('pdf-merge-input').click()">
                                <div style="font-size:2rem; margin-bottom:8px;">üìö</div>
                                <div style="font-weight:700;">Upload 2+ pdf documents</div>
                                <div style="font-size:0.7rem; opacity:0.6;">Files will be merged in order of selection</div>
                                <input type="file" id="pdf-merge-input" multiple style="display:none" onchange="app.handlePdfMergeLoad(event)">
                            </div>
                            <div id="pdf-merge-list" style="margin-top:20px; display:flex; flex-direction:column; gap:8px;"></div>
                        </div>
            `;
                }
            }

            async handlePdfLoad(event) {
                const file = event.target.files[0];
                if (!file) return;
                this.currentPdfFile = file;
                this.addLog(`pdf Loaded: ${file.name} `);

                // Visual feedback: Activate pulse
                const dropzone = document.querySelector('.pdf-dropzone');
                if (dropzone) dropzone.classList.add('active');

                // Simplified preview for Alpha
                document.getElementById('pdf-preview-canvas').innerHTML = `
            <div style = "text-align:center; animation: fade-in 0.5s ease;" >
                        <div style="font-size:3rem; margin-bottom:12px;">‚úÖ</div>
                        <div style="color:var(--primary); font-weight:800; font-size:1.1rem; letter-spacing:-0.02em;">${file.name}</div>
                        <div style="font-size:0.7rem; opacity:0.6; margin-top:8px; text-transform:uppercase; letter-spacing:0.1em;">Ready for Surgical Overlay</div>
                    </div>
            `;
            }

            async executePdfOverlay() {
                if (!this.currentPdfFile) { alert("Load a pdf first."); return; }
                this.addLog("Executing Surgical Overlay...");

                try {
                    const arrayBuffer = await this.currentPdfFile.arrayBuffer();
                    const pdfDoc = await pdfLib.pdfDocument.load(arrayBuffer);
                    const pages = pdfDoc.getPages();
                    const firstPage = pages[0];
                    const text = document.getElementById('pdf-text-value').value || "Justice McKinney";
                    const x = parseInt(document.getElementById('pdf-text-x').value);
                    const y = parseInt(document.getElementById('pdf-text-y').value);

                    firstPage.drawText(text, { x, y, size: 12, color: pdfLib.rgb(0, 0, 0) });

                    const pdfBytes = await pdfDoc.save();
                    this.downloadPdf(pdfBytes, `Modified_${this.currentPdfFile.name} `);
                    this.addLog("Overlay completed successfully.");
                } catch (e) {
                    console.error(e);
                    alert("Overlay failed. See console.");
                }
            }

            async handlePdfMergeLoad(event) {
                this.mergeFiles = Array.from(event.target.files);
                const list = document.getElementById('pdf-merge-list');
                list.innerHTML = this.mergeFiles.map(f => `
            <div class="diag-badge" style = "justify-content:space-between; cursor:default;" >
                        <span>üìÑ ${f.name}</span>
                        <span style="opacity:0.5; font-size:0.65rem;">${(f.size / 1024).toFixed(1)} KB</span>
                    </div>
            `).join('');
                this.addLog(`Queued ${this.mergeFiles.length} files for merge.`);
            }

            async executePdfMerge() {
                if (!this.mergeFiles || this.mergeFiles.length < 2) { alert("Load at least 2 pdfs."); return; }
                this.addLog("Initiating Document Merge...");

                try {
                    const mergedPdf = await pdfLib.pdfDocument.create();
                    for (const file of this.mergeFiles) {
                        const bytes = await file.arrayBuffer();
                        const pdf = await pdfLib.pdfDocument.load(bytes);
                        const copiedPages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
                        copiedPages.forEach((page) => mergedPdf.addPage(page));
                    }
                    const pdfBytes = await mergedPdf.save();
                    this.downloadPdf(pdfBytes, "Surgical_Merge_Result.pdf");
                    this.addLog("Merge completed successfully.");
                } catch (e) {
                    console.error(e);
                    alert("Merge failed.");
                }
            }

            downloadPdf(bytes, filename) {
                const blob = new Blob([bytes], { type: "application/pdf" });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.click();
            }

            extractDate(doc) {
                const dateRegex = /(\d{4}-\d{2}-\d{2})/;
                const match = doc.path.match(dateRegex) || doc.name.match(dateRegex);
                return match ? match[1] : '0000-00-00';
            }

            toggleArchive(path) {
                const idx = this.state.archivedDocs.indexOf(path);
                if (idx > -1) {
                    this.state.archivedDocs.splice(idx, 1);
                } else {
                    this.state.archivedDocs.push(path);
                }
                this.saveLocal();
                this.renderRegistry();
            }

            toggleVault(path) {
                const idx = this.state.vaultedDocs.indexOf(path);
                if (idx > -1) {
                    this.state.vaultedDocs.splice(idx, 1);
                } else {
                    this.state.vaultedDocs.push(path);
                }
                this.saveLocal();
                this.renderRegistry();
            }

            renderRegistry() {
                const container = document.getElementById('task-sections-container');
                let html = '<div class="hub-container fade-in">';

                // Registry Header (Surgical Vault Pivot - Silas)
                const isVault = document.getElementById('vault-toggle')?.checked ?? true;
                html += `
                    <div class="card" style="margin-bottom:20px;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div class="card-title"><span class="dot" style="background:var(--primary)"></span>Surgical Vault [V8.9.2]</div>
                            <label class="switch-ui" style="display:flex; align-items:center; gap:8px; cursor:pointer;" title="Silas Vance Optimization: Hide lower-leverage files">
                                <span style="font-size:0.7rem; font-weight:700; opacity:0.6;">VAULT MODE</span>
                                <input type="checkbox" id="vault-toggle" ${isVault ? 'checked' : ''} onchange="app.render()" style="display:none;">
                                <div class="switch-bg" style="width:34px; height:18px; background:${isVault ? 'var(--gold)' : 'var(--border)'}; border-radius:10px; position:relative; transition:background 0.3s;">
                                    <div class="switch-knob" style="width:14px; height:14px; background:#000; border-radius:50%; position:absolute; ${isVault ? 'right' : 'left'}:2px; top:2px; transition:all 0.3s;"></div>
                                </div>
                            </label>
                        </div>
                        <p style="font-size:0.8rem; color:var(--text-dim); margin-top:8px;">High-leverage clinical assets and core strategic playbooks.</p>
                    </div>
                `;

                const entries = Object.entries(this.registryData);
                if (entries.length === 0) {
                    html += `
                        <div class="card" style="margin-top:20px; text-align:center; padding:40px; opacity:0.6;">
                            <div style="font-size:3rem; margin-bottom:12px;">üì°</div>
                            <div class="card-title">Registry Data Offline</div>
                            <p>Unable to fetch document manifest. This is expected if viewing via <code>file://</code> protocol without the sidecar server.</p>
                        </div>
                    `;
                }

                entries.forEach(([key, cat]) => {
                    const isVisible = (this.mode === 'registry' || cat.lanes.includes(this.mode) || cat.lanes.includes('shared'));
                    if (!isVisible) return;

                    // Sort: Latest to Oldest
                    const sortedDocs = [...cat.docs].sort((a, b) => {
                        const dateA = this.extractDate(a);
                        const dateB = this.extractDate(b);
                        if (dateA !== dateB) return dateB.localeCompare(dateA);
                        return a.name.localeCompare(b.name);
                    });

                    // Silas Vance: Vault Filtering
                    const isVault = document.getElementById('vault-toggle')?.checked ?? true;
                    let filteredDocs = sortedDocs;
                    if (isVault) {
                        filteredDocs = sortedDocs.filter(d =>
                            d.priority === 'high' ||
                            d.path.includes('playbook') ||
                            d.path.includes('Revenue') ||
                            d.path.includes('Deferred') ||
                            d.path.includes('Money_Shot')
                        );
                    }

                    if (filteredDocs.length === 0) return;

                    // Default to collapsed unless explicitly set to false
                    const isCollapsed = this.state[this.mode].collapsed ? this.state[this.mode].collapsed[cat.title] !== false : true;

                    // Separate archived and active for filtered set
                    const activeDocs = filteredDocs.filter(d => !this.state.archivedDocs.includes(d.path));
                    const archivedDocs = filteredDocs.filter(d => this.state.archivedDocs.includes(d.path));

                    const renderDoc = (doc) => {
                        const mdPath = doc.isOnlyPdf ? '#' : this.resolveDocPath(doc.path, false);
                        const pdfPath = this.resolveDocPath(doc.path, true);
                        const isArchived = this.state.archivedDocs.includes(doc.path);
                        const isVaulted = this.state.vaultedDocs.includes(doc.path);

                        return `
                            <div class="registry-item ${isArchived ? 'archived' : ''} ${isVaulted ? 'vaulted' : ''}" >
                                <div class="registry-info">
                                    <div class="registry-name">${doc.name} ${isArchived ? 'üíé' : ''} ${isVaulted ? 'üìÅ' : ''}</div>
                                    <div class="registry-meta">${doc.path.split('/').pop().split('.').shift()}</div>
                                </div>
                                <div class="registry-actions">
                                    <button class="action-icon" title="${isArchived ? 'Restore' : 'Flag for Value Essence Archive'}" onclick="app.toggleArchive('${doc.path}')">${isArchived ? 'üîì' : 'üíé'}</button>
                                    ${isArchived ? `<button class="action-icon" title="${isVaulted ? 'Unflag for Vault' : 'Ready for Deep Storage Vault'}" onclick="app.toggleVault('${doc.path}')">${isVaulted ? 'üîô' : 'üìÅ'}</button>` : ''}
                                    ${!doc.isOnlyPdf ? `<a href="${mdPath}" class="action-icon" title="View markdown" onclick="app.openReader('${mdPath}', '${doc.name}'); return false;">üìù</a>` : ''}
                                    ${doc.pdf ? `<a id="pdf-${key}" href="${pdfPath}" class="action-icon pdf" title="View pdf">üìï</a>` : ''}
                                </div>
                            </div>
                        `;
                    };

                    if (activeDocs.length > 0 || archivedDocs.length > 0) {
                        html += `
                            <div class="registry-lane ${isCollapsed ? 'collapsed' : ''}" >
                                <div class="registry-lane-title" onclick="app.toggleSection('${cat.title}')">
                                    <span class="section-chevron" style="transform: ${isCollapsed ? 'rotate(-90deg)' : 'rotate(0deg)'}; margin-right:8px;">‚ñº</span>
                                    ${cat.icon} ${cat.title}
                                </div>
                                <div class="registry-grid" style="display: ${isCollapsed ? 'none' : 'grid'}">
                                    ${activeDocs.map(d => renderDoc(d)).join('')}
                                    ${archivedDocs.map(d => renderDoc(d)).join('')}
                                </div>
                            </div>
                        `;
                    }
                });

                // pdf Surgical Laboratory - Integrated at bottom
                html += `
            <div class="card" style = "margin-top:40px; border-top: 2px solid var(--primary-dim);" >
                        <div class="card-title"><span class="dot" style="background:var(--gold)"></span>pdf Surgical Laboratory</div>
                        <p style="font-size:0.8rem; color:var(--text-dim); margin-bottom:20px;">Surgical document modification. Tool integrated for direct registry workflow [V8.8.9-Alpha].</p>
                        
                        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:16px;">
                            <div class="diag-badge ${this.activePdfTool === 'overlay' ? 'active' : ''}" style="padding:16px; height:auto; flex-direction:column; align-items:flex-start; gap:8px;" onclick="app.setPdfTool('overlay')">
                                <span style="font-size:1.2rem;">‚úçÔ∏è</span>
                                <div style="font-weight:700;">Text Overlay</div>
                                <div style="font-size:0.65rem; opacity:0.7;">Add dates/names to docs</div>
                            </div>
                            <div class="diag-badge ${this.activePdfTool === 'merge' ? 'active' : ''}" style="padding:16px; height:auto; flex-direction:column; align-items:flex-start; gap:8px;" onclick="app.setPdfTool('merge')">
                                <span style="font-size:1.2rem;">üîó</span>
                                <div style="font-weight:700;">Merge pdfs</div>
                                <div style="font-size:0.65rem; opacity:0.7;">Combine multiple files</div>
                            </div>
                            <div class="diag-badge ${this.activePdfTool === 'flatten' ? 'active' : ''}" style="padding:16px; height:auto; flex-direction:column; align-items:flex-start; gap:8px;" onclick="app.setPdfTool('flatten')">
                                <span style="font-size:1.2rem;">üìë</span>
                                <div style="font-weight:700;">Flatten Forms</div>
                                <div style="font-size:0.65rem; opacity:0.7;">Seal fields for submittal</div>
                            </div>
                        </div>
                        
                        <div id="pdf-tool-stage" style="margin-top:20px;">
                            ${this.activePdfTool ? '' : `
                                <div style="text-align:center; padding:40px; color:var(--text-dim); opacity:0.5; border: 2px dashed var(--border); border-radius:12px;">
                                    Select a surgical tool to begin configuration.
                                </div>
                            `}
                        </div>
                    </div>
                `;

                html += '</div>';
                container.innerHTML = html;
                if (this.activePdfTool) this.renderPdfStage();
            }

            toggleSection(sectionKey) {
                this.state[this.mode].collapsed = this.state[this.mode].collapsed || {};
                this.state[this.mode].collapsed[sectionKey] = !this.state[this.mode].collapsed[sectionKey];
                this.saveLocal();
                this.render();
            }
        }

        window.app = new MasterApp();

        window.addEventListener('load', () => {
            // Initial render removed - handled by init()
            window.app.handleDeepLink();
        });
        window.addEventListener('hashchange', () => window.app.handleDeepLink());
    </script>
</body>

</html><!-- Deployment Trigger: 02/18/2026 03:28:08 -->